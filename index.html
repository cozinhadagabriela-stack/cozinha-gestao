<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cozinha da Gabriela - Gestão</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS separado -->
  <link rel="stylesheet" href="styles.css" />

  <!-- ✅ Overrides de layout: "login central" quando deslogado -->
  <style>
    /* Estado padrão (deslogado) */
    body.logged-out {
      min-height: 100vh;
    }

    /* Esconde o header completo quando estiver deslogado (vamos usar um topo próprio do login) */
    body.logged-out header {
      display: none !important;
    }

    /* Centraliza tudo, mas um pouco mais pra cima */
    body.logged-out main {
      min-height: 100vh;
      display: flex;
      align-items: flex-start;      /* ⬅️ em vez de center */
      justify-content: center;
      padding: 24px;
      padding-top: 70px;            /* ⬅️ ajusta a altura (mais pra cima) */
    }

    /* Wrapper do login + topo */
    body.logged-out .login-wrapper {
      width: 100%;
      max-width: 520px;
    }

    /* Título do login (em cima) */
    body.logged-out .login-topbar {
      width: 100%;
      padding: 14px 18px;
      border-radius: 14px;
      margin-bottom: 100px;
      text-align: center;
      font-weight: 800;
      font-size: 18px;
      letter-spacing: 0.2px;

      background: #b00000;
      color: #fff;
    }

    /* Card de login mais "quadrado" e compacto */
    body.logged-out #login-card.card {
      width: 100%;
      max-width: 520px;
      padding: 26px;
      border-radius: 14px;
    }

    body.logged-out #login-card h2 {
      margin-top: 0;
      margin-bottom: 14px;
      text-align: left;
    }

    body.logged-out #login-card .form-group {
      margin-bottom: 14px;
    }

    body.logged-out #login-card input {
      width: 100%;
      height: 44px;
      border-radius: 10px;
    }

    body.logged-out #btn-login {
      width: 100%;
      height: 44px;
      border-radius: 10px;
      margin-top: 6px;
    }

    /* Link "Esqueci minha senha" */
    .forgot-wrap {
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }

    #btn-forgot {
      background: transparent;
      border: 1px solid rgba(0,0,0,0.35);
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 14px;
      opacity: 0.9;
    }

    #btn-forgot:hover {
      opacity: 1;
    }

    /* Mensagens */
    body.logged-out #login-error {
      margin-top: 10px;
    }
  </style>

  <!-- Firebase SDKs (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <!-- Configuração do Firebase -->
  <script src="firebase-config.js"></script>

  <!-- Chart.js para os gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Módulos da aplicação -->
  <script src="js/state.js" defer></script>
  <script src="js/ui.js" defer></script>
  <script src="js/cadastros.js" defer></script>
  <script src="js/estoque.js" defer></script>
  <script src="js/vendas.js" defer></script>
  <script src="js/despesas.js" defer></script>
  <script src="js/auth.js" defer></script>

  <!-- ✅ Script: alterna logged-out / logged-in conforme o app aparece + reset senha -->
  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      const body = document.body;
      const loginCard = document.getElementById("login-card");
      const appCard = document.getElementById("app-card");

      function updateLayoutMode() {
        const isLoggedIn = appCard && !appCard.classList.contains("hidden");
        body.classList.toggle("logged-in", isLoggedIn);
        body.classList.toggle("logged-out", !isLoggedIn);
      }

      updateLayoutMode();

      const obs = new MutationObserver(updateLayoutMode);
      if (loginCard) obs.observe(loginCard, { attributes: true, attributeFilter: ["class"] });
      if (appCard) obs.observe(appCard, { attributes: true, attributeFilter: ["class"] });

      // ✅ Esqueci senha (Firebase Auth: sendPasswordResetEmail)
      const btnForgot = document.getElementById("btn-forgot");
      const emailInput = document.getElementById("login-email");
      const loginError = document.getElementById("login-error");
      const loading = document.getElementById("loading");

      if (btnForgot) {
        btnForgot.addEventListener("click", async () => {
          const email = (emailInput?.value || "").trim();

          if (!email) {
            if (loginError) loginError.textContent = "Digite seu e-mail acima para receber o link de redefinição.";
            return;
          }

          try {
            if (loginError) loginError.textContent = "";
            if (loading) loading.classList.remove("hidden");

            await firebase.auth().sendPasswordResetEmail(email);

            if (loginError) {
              loginError.textContent = "Pronto! Se o e-mail estiver cadastrado, você receberá um link para redefinir a senha.";
            }
          } catch (err) {
            if (loginError) {
              loginError.textContent = "Não foi possível enviar o e-mail de redefinição. Verifique o e-mail e tente novamente.";
            }
            console.error(err);
          } finally {
            if (loading) loading.classList.add("hidden");
          }
        });
      }
    });
  </script>
</head>

<body class="logged-out">
  <header>
    <h1>Cozinha da Gabriela - Gestão</h1>
    <div id="user-info">
      <span id="user-email"></span>
      <button id="btn-logout">Sair</button>
    </div>
  </header>

  <main>
    <!-- ✅ Wrapper: topo + card -->
    <div class="login-wrapper">
      <!-- ✅ alterado -->
      <div class="login-topbar">ERP - Cozinha da Gabriela</div>

      <!-- LOGIN -->
      <div id="login-card" class="card">
        <h2>Login</h2>
        <div class="form-group">
          <label for="login-email">E-mail</label>
          <input type="email" id="login-email" placeholder="seuemail@exemplo.com" />
        </div>
        <div class="form-group">
          <label for="login-password">Senha</label>
          <input type="password" id="login-password" placeholder="Sua senha" />
        </div>
        <button id="btn-login" class="btn-primario">Entrar</button>

        <div class="forgot-wrap">
          <button id="btn-forgot" type="button">Esqueci minha senha</button>
        </div>

        <span id="loading" class="loading hidden">Carregando...</span>
        <p id="login-error" class="msg error"></p>
      </div>
    </div>

    <!-- APP -->
    <div id="app-card" class="card hidden">
      <!-- Abas -->
      <div class="tabs">
        <button id="tab-venda" class="tab active-tab">Venda</button>
        <button id="tab-extrato" class="tab">Extrato / Relatório</button>
        <button id="tab-estoque" class="tab">Estoque</button>
        <button id="tab-despesas" class="tab">Despesas</button>
        <button id="tab-clientes" class="tab">Clientes</button>
        <button id="tab-produtos" class="tab">Produtos</button>
        <button id="tab-formas" class="tab">Formas de pagamento</button>
      </div>

      <!-- Venda -->
      <div id="section-venda" class="section">
        <h2>Registrar venda</h2>

        <div class="form-grid">
          <div class="form-group">
            <label for="sale-date">Data da venda</label>
            <input type="date" id="sale-date">
          </div>

          <div class="form-group">
            <label for="sale-client">Cliente</label>
            <select id="sale-client">
              <option value="">Selecione um cliente</option>
            </select>
          </div>

          <div class="form-group">
            <label for="sale-payment">Forma de pagamento</label>
            <select id="sale-payment">
              <option value="">Selecione a forma de pagamento</option>
            </select>
          </div>

          <div class="form-group">
            <label for="sale-nf-number">Nº Nota Fiscal</label>
            <input type="text" id="sale-nf-number" placeholder="Ex.: 12345">
          </div>
        </div>

        <h3>Itens do pedido</h3>

        <div class="form-grid">
          <div class="form-group">
            <label for="sale-product">Produto</label>
            <select id="sale-product">
              <option value="">Selecione um produto</option>
            </select>
          </div>

          <div class="form-group">
            <label for="sale-lote">Lote</label>
            <input type="text" id="sale-lote" placeholder="Ex.: 2025-001" maxlength="8">
          </div>

          <div class="form-group">
            <label for="sale-quantity">Quantidade</label>
            <input type="number" id="sale-quantity" min="1" value="1">
          </div>

          <div class="form-group">
            <label for="sale-unit-price">Valor unitário (R$)</label>
            <input type="number" step="0.01" id="sale-unit-price" placeholder="0,00">
          </div>
        </div>

        <button id="btn-add-item" class="btn-primario">Adicionar item</button>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Produto</th>
                <th>Lote</th>
                <th>Quantidade</th>
                <th>Valor unitário (R$)</th>
                <th>Total (R$)</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="pedido-itens-tbody">
              <tr><td colspan="6">Nenhum item adicionado.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="form-group">
          <label for="sale-total">Total do pedido (R$)</label>
          <input type="number" step="0.01" id="sale-total" placeholder="0,00" readonly>
        </div>

        <button id="btn-save-sale" class="btn-primario">Salvar venda</button>
        <p id="sale-message" class="msg"></p>
      </div>

      <!-- Extrato / Relatório -->
      <div id="section-extrato" class="section hidden">
        <h2>Extrato de vendas</h2>
        <!-- ... resto do seu HTML continua igual ... -->
      </div>

      <!-- Estoque -->
      <div id="section-estoque" class="section hidden">
        <h2>Estoque de produtos acabados</h2>
        <!-- ... resto do seu HTML continua igual ... -->
      </div>

      <!-- Despesas -->
      <div id="section-despesas" class="section hidden">
        <h2>Despesas</h2>
        <!-- ... resto do seu HTML continua igual ... -->
      </div>

      <!-- Clientes -->
      <div id="section-clientes" class="section hidden">
        <h2>Cadastro de clientes</h2>
        <!-- ... resto do seu HTML continua igual ... -->
      </div>

      <!-- Produtos -->
      <div id="section-produtos" class="section hidden">
        <h2>Cadastro de produtos</h2>
        <!-- ... resto do seu HTML continua igual ... -->
      </div>

      <!-- Formas de pagamento -->
      <div id="section-formas" class="section hidden">
        <h2>Formas de pagamento</h2>
        <!-- ... resto do seu HTML continua igual ... -->
      </div>
    </div>
  </main>
</body>
</html>
